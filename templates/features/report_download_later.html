{% extends "layouts/base.html" %}

{% block title %}Health Report | HridyaCare{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================= GLOBAL THEME ================= */
* { font-family: "Outfit", "Segoe UI", system-ui, sans-serif; box-sizing: border-box; }

body {
    background: #0f172a !important;
    background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%) !important;
    background-attachment: fixed;
}
:root {
    --primary: #f43f5e; 
    --primary-hover: #ff4769;
    --card-bg: linear-gradient(145deg, #1e293b, #0f172a); 
    --card-border: rgba(255, 255, 255, 0.08);
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    --text-muted: #94a3b8;
    --success: #10b981;
}

/* ================= LOADING SPINNER ================= */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(8px);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 10000; transition: 0.3s opacity;
    visibility: hidden; opacity: 0;
}
.spinner {
    width: 50px; height: 50px;
    border: 4px solid rgba(244, 63, 94, 0.1);
    border-top: 4px solid var(--primary);
    border-radius: 50%; animation: spin 1s linear infinite;
    margin-bottom: 15px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loading-text { color: #fff; font-weight: 600; font-size: 1.1rem; letter-spacing: 0.5px; }

/* ================= COMPONENTS ================= */
.report-card, .card {
    background: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    box-shadow: var(--card-shadow);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
}

.page-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; text-align: center; }
.page-title { font-size: 28px; font-weight: 800; color: #fff; margin-bottom: 8px; }
.page-subtitle { color: var(--text-muted); font-size: 0.95rem; max-width: 500px; line-height: 1.5; }

/* Dropdowns */
.profile-selector { width: 100%; max-width: 400px; margin: 0 auto 25px; }
.profile-select, .reading-select {
    width: 100%; background: rgba(30, 41, 59, 0.7); border: 1px solid var(--card-border);
    border-radius: 12px; padding: 14px 20px; color: #fff; font-size: 1rem; font-weight: 600;
    cursor: pointer; transition: 0.3s; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 15px center; background-size: 15px;
}
.reading-select {
    background: rgba(255, 255, 255, 0.05); /* Slightly lighter for distinction */
    margin-bottom: 15px;
}

.section { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.section:last-child { border-bottom: none; }

.row { display: flex; justify-content: space-between; margin: 8px 0; align-items: center; }
.row span:first-child { color: var(--text-muted); font-weight: 500; }
.row span:last-child { color: #fff; font-weight: 700; text-align: right; }

.impact-box {
    margin-top: 15px; padding: 14px; border-radius: 12px;
    background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center; font-weight: 700; font-size: 1.1rem;
}
.message { margin-top: 10px; font-size: 0.9rem; color: #cbd5e1; text-align: center; font-style: italic; }

/* Stats & Table */
.stats-grid { display: flex; justify-content: space-between; text-align: center; margin-bottom: 20px; }
.stat-item { flex: 1; }
.stat-item h3 { color: #fff; font-size: 22px; margin: 0; font-weight: 800; }
.stat-item p { color: var(--text-muted); font-size: 11px; margin-top: 4px; font-weight: 600; text-transform: uppercase; }
.stat-divider { width: 1px; height: 30px; background: rgba(255,255,255,0.1); }

.table-wrapper { overflow-x: auto; margin-top: 10px; }
.hr-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.hr-table th { color: #cbd5e1; background: rgba(255, 255, 255, 0.02); padding: 12px; text-align: left; font-size: 0.75rem; font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-transform: uppercase; }
.hr-table td { padding: 14px 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #e2e8f0; font-weight: 500; }

/* Buttons & Actions */
.actions { display: flex; flex-direction: column; gap: 10px; padding-top: 10px; }
.btn-action { width: 100%; padding: 16px; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; border: none; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
.pdf-btn { background: linear-gradient(135deg, #f43f5e, #be123c); color: #fff; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
.wa-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
.back-btn-action { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); }

/* Toast */
#downloadToast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s; }
#downloadToast.show { opacity: 1; visibility: visible; bottom: 50px; }
.empty-state { text-align: center; padding: 50px 20px; display: none; }
</style>
{% endblock %}

{% block content %}
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Fetching health records...</div>
</div>

<div class="page-header">
    <div class="page-title">Detailed Health Report</div>
    <div class="page-subtitle">View insights and download specific reports.</div>
</div>

<div class="profile-selector">
    <select id="memberSelect" class="profile-select" onchange="changeMember()">
        <option value="" disabled selected>Loading profiles...</option>
    </select>
</div>

<div id="reportContent" style="display: none;">
    <div class="report-card">
        <div class="section" style="padding-top:0;">
            <div class="row"><span>Patient Name</span><span id="r-name">--</span></div>
            <div class="row"><span>Age / City</span><span id="r-details">--</span></div>
            <div class="row"><span>Selected Reading</span><span id="r-time" style="color:#cbd5e1;">--</span></div>
        </div>
        <div class="section">
            <div class="row"><span>Heart Rate</span><span id="r-bpm" style="font-size:1.3rem; color:var(--primary);">--</span></div>
            <div class="row"><span>AQI Level</span><span id="r-aqi">--</span></div>
            <div class="row"><span>PM2.5 / PM10</span><span id="r-pm">--</span></div>
        </div>
        <div class="section" style="border:none; padding-bottom:0;">
            <div id="impact-box" class="impact-box"><span id="r-impact">Analyzing...</span></div>
            <div id="r-message" class="message"></div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:15px; color:#fff; font-size:18px; font-weight:700;"><i class="fa-solid fa-chart-line" style="margin-right:8px; color:var(--primary);"></i> Heart Rate Trends</h3>
        <div class="stats-grid">
            <div class="stat-item"><h3 id="avgBpm">--</h3><p>AVG BPM</p></div>
            <div class="stat-divider"></div>
            <div class="stat-item"><h3 id="maxBpm">--</h3><p>MAX</p></div>
            <div class="stat-divider"></div>
            <div class="stat-item"><h3 id="minBpm">--</h3><p>MIN</p></div>
        </div>
        <div style="height: 250px; position: relative;"><canvas id="heartRateChart"></canvas></div>
    </div>

    <div class="card">
        <h3 style="margin-bottom:15px; color:#fff; font-size:18px; font-weight:700;"><i class="fa-solid fa-heart-pulse" style="margin-right:8px; color:var(--primary);"></i> Last 7 Measurements</h3>
        <div class="table-wrapper">
            <table class="hr-table">
                <thead><tr><th>Date</th><th>Time</th><th>BPM</th><th>Status</th></tr></thead>
                <tbody id="heartRateTable"></tbody>
            </table>
        </div>
    </div>

    <div class="actions">
        <label style="color:var(--text-muted); font-size:0.8rem; padding-left:5px; margin-bottom:5px;">Select Reading to Download:</label>
        <select id="readingSelect" class="reading-select" onchange="handleReadingChange()">
            </select>

        <button class="btn-action pdf-btn" onclick="generatePDF()"><i class="fa-solid fa-file-pdf"></i> Download PDF Report</button>
        <button class="btn-action wa-btn" onclick="sendWhatsApp()"><i class="fa-brands fa-whatsapp"></i> Share Selected via WhatsApp</button>
        <button class="btn-action back-btn-action" onclick="copyReport()"><i class="fa-solid fa-copy"></i> Copy Selected Text</button>
    </div>
</div>

<div id="noDataState" class="empty-state">
    <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ“‰</div>
    <h3 style="color: #fff;">No Health Data Found</h3>
    <p style="color: var(--text-muted);">Recorded measurements for this profile will appear here.</p>
</div>

<div id="downloadToast">
    <i class="fa-solid fa-circle-check"></i>
    <span id="toastMsg">Success!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
    // State
    let currentReportData = {
        member: null,
        history: [],
        selectedReading: null
    };
    let chartInstance = null;

    // --- UTILS ---
    function toggleLoader(show) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.visibility = show ? "visible" : "hidden";
        overlay.style.opacity = show ? "1" : "0";
    }

    function parseDateString(str) {
        if (!str) return { date: "--", time: "--" };
        const dateObj = new Date(str);
        return isNaN(dateObj.getTime()) ? { date: str, time: "" } : {
            date: dateObj.toLocaleDateString('en-US', {day:'numeric', month:'short'}),
            time: dateObj.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'})
        };
    }

    function showToast(msg) {
        const toast = document.getElementById("downloadToast");
        document.getElementById("toastMsg").innerText = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // --- MAIN LOADING ---
    document.addEventListener("DOMContentLoaded", () => {
        loadFamilyMembers();
    });

    async function loadFamilyMembers() {
        toggleLoader(true);
        try {
            const res = await fetch('/api/family-members');
            const members = await res.json();
            
            const select = document.getElementById("memberSelect");
            select.innerHTML = '';
            
            members.sort((a, b) => (a.relationship || "").toLowerCase() === 'self' ? -1 : 1);
            
            members.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.id;
                opt.text = (m.relationship || "").toLowerCase() === 'self' ? "You (Self)" : `${m.name} (${m.relationship})`;
                select.appendChild(opt);
            });

            const preferred = localStorage.getItem("HCARE_MEMBER_ID");
            if (preferred && members.find(m => m.id == preferred)) select.value = preferred;
            
            changeMember();
        } catch (e) { 
            console.error("Error loading profiles", e);
            toggleLoader(false);
        }
    }

    async function changeMember() {
        toggleLoader(true);
        const memberId = document.getElementById("memberSelect").value;
        if (!memberId) { toggleLoader(false); return; }
        localStorage.setItem("HCARE_MEMBER_ID", memberId);

        try {
            const [mRes, hRes] = await Promise.all([
                fetch(`/api/member/${memberId}`),
                fetch(`/api/heart-rate/last-7?member_id=${memberId}`)
            ]);

            const memberData = await mRes.json();
            const historyData = await hRes.json();

            if (!historyData || historyData.length === 0) {
                document.getElementById("reportContent").style.display = "none";
                document.getElementById("noDataState").style.display = "block";
                toggleLoader(false);
                return;
            }

            // Update State
            currentReportData.member = memberData;
            currentReportData.history = historyData;

            // Render Components
            renderHistoryTable(historyData);
            renderChart(historyData);
            populateReadingSelect(historyData);

            document.getElementById("reportContent").style.display = "block";
            document.getElementById("noDataState").style.display = "none";
            
            setTimeout(() => toggleLoader(false), 500);
        } catch (e) {
            console.error(e);
            toggleLoader(false);
        }
    }

    // Populates the dropdown above the download button
    function populateReadingSelect(history) {
        const select = document.getElementById("readingSelect");
        select.innerHTML = '';

        history.forEach((h, index) => {
            const dt = parseDateString(h.time);
            const opt = document.createElement("option");
            opt.value = index; // Store index as value
            // Example: "Jan 26 - 10:30 PM (98 BPM)"
            opt.text = `${dt.date} â€¢ ${dt.time} (${h.bpm} BPM)`;
            select.appendChild(opt);
        });

        // Auto-select the first one (latest)
        handleReadingChange();
    }

    // Called when user changes the dropdown above Download button
    function handleReadingChange() {
        const select = document.getElementById("readingSelect");
        const index = select.value;
        
        // Update current selected reading
        currentReportData.selectedReading = currentReportData.history[index];
        
        // Update UI Top Cards
        updateMainCards(currentReportData.member, currentReportData.selectedReading);
    }

    function updateMainCards(member, reading) {
        // Name Logic: If Self, show "Self", else show Name
        const isSelf = (member.relationship || "").toLowerCase() === "self";
        document.getElementById("r-name").innerText = isSelf ? "Self" : member.name;
        document.getElementById("r-details").innerText = `${member.age || '--'} yrs â€¢ ${member.city || '--'}`;
        
        const t = parseDateString(reading.time);
        document.getElementById("r-time").innerText = `${t.date} â€¢ ${t.time}`;
        document.getElementById("r-bpm").innerText = reading.bpm + " BPM";

        const aqi = reading.aqi || 0;
        let aqiColor = aqi <= 50 ? "#22c55e" : aqi <= 100 ? "#eab308" : "#ef4444";
        document.getElementById("r-aqi").innerHTML = `<span style="color:${aqiColor}">${aqi}</span>`;
        document.getElementById("r-pm").innerText = `${reading.pm25 || '-'} / ${reading.pm10 || '-'}`;

        let statusColor = reading.bpm > 100 ? "#ef4444" : reading.bpm < 60 ? "#3b82f6" : "#22c55e";
        const box = document.getElementById("impact-box");
        box.style.color = statusColor; 
        box.style.borderColor = statusColor;
        
        let statusText = "Normal Heart Rate";
        if(reading.bpm > 100) statusText = "High Heart Rate";
        if(reading.bpm < 60) statusText = "Low Heart Rate";
        document.getElementById("r-impact").innerText = statusText;

        // Stats from full history
        const bpms = currentReportData.history.map(h => h.bpm);
        document.getElementById("avgBpm").innerText = Math.round(bpms.reduce((a,b)=>a+b,0)/bpms.length);
        document.getElementById("maxBpm").innerText = Math.max(...bpms);
        document.getElementById("minBpm").innerText = Math.min(...bpms);
    }

    function renderHistoryTable(history) {
        const tbody = document.getElementById("heartRateTable");
        tbody.innerHTML = history.map(h => {
            const dt = parseDateString(h.time);
            let c = h.bpm > 100 ? "#ef4444" : h.bpm < 60 ? "#3b82f6" : "#22c55e";
            let s = h.bpm > 100 ? "High" : h.bpm < 60 ? "Low" : "Normal";
            return `<tr>
                <td>${dt.date}</td>
                <td style="color:#94a3b8">${dt.time}</td>
                <td>${h.bpm}</td>
                <td><span style="background:${c}; width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:8px;"></span>${s}</td>
            </tr>`;
        }).join('');
    }

    function renderChart(history) {
        const ctx = document.getElementById('heartRateChart');
        if (chartInstance) chartInstance.destroy();
        const data = [...history].reverse();
        
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => parseDateString(d.time).date),
                datasets: [{ 
                    label: 'BPM', 
                    data: data.map(d => d.bpm), 
                    backgroundColor: '#f43f5e', 
                    borderRadius: 6, 
                    barThickness: 20 
                }]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' }, suggestedMin: 40 }
                }
            }
        });
    }

    // --- ACTIONS ---

    async function generatePDF() {
        if (!currentReportData.selectedReading) return;
        
        const btn = document.querySelector(".pdf-btn");
        const originalText = btn.innerHTML;
        btn.disabled = true; 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

        try {
            const isSelf = (currentReportData.member.relationship || "").toLowerCase() === "self";
            
            // PAYLOAD: Uses currently selected reading + full history
            const payload = {
                name: isSelf ? "Self" : currentReportData.member.name,
                city: currentReportData.member.city || "N/A",
                age: currentReportData.member.age || "N/A",
                
                bpm: currentReportData.selectedReading.bpm,
                aqi: currentReportData.selectedReading.aqi || 0,
                pm25: currentReportData.selectedReading.pm25 || 0,
                pm10: currentReportData.selectedReading.pm10 || 0,
                timestamp: currentReportData.selectedReading.time,
                
                impactCategory: document.getElementById("r-impact").innerText,
                history: currentReportData.history
            };

            const response = await fetch("/generate-pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if(!response.ok) throw new Error("Server failed");

            const data = await response.json(); 
            const fileRes = await fetch(data.pdf_url);
            const blob = await fileRes.blob();
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `HridyaCare_Report_${Date.now()}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            showToast("Report Downloaded!");
        } catch (error) {
            console.error(error);
            alert("Error generating PDF.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function sendWhatsApp() {
        if (!currentReportData.selectedReading) return;
        
        const phoneInput = prompt("Enter 10-digit WhatsApp number:");
        if (!phoneInput) return;
        
        const cleanPhone = phoneInput.replace(/\D/g, "");
        if (cleanPhone.length !== 10) { alert("Invalid number"); return; }
        
        const name = (currentReportData.member.relationship || "").toLowerCase() === "self" ? "Self" : currentReportData.member.name;
        const bpm = currentReportData.selectedReading.bpm;
        const city = currentReportData.member.city || "N/A";
        const t = parseDateString(currentReportData.selectedReading.time);

        const msg = `*HridyaCare Health Report*\n\nðŸ‘¤ Name: ${name}\nâ¤ï¸ BPM: ${bpm}\nðŸ“ City: ${city}\nðŸ“… Date: ${t.date} ${t.time}`;
        
        window.open(`https://wa.me/91${cleanPhone}?text=${encodeURIComponent(msg)}`, "_blank");
    }

    function copyReport() {
        if (!currentReportData.selectedReading) return;
        const name = (currentReportData.member.relationship || "").toLowerCase() === "self" ? "Self" : currentReportData.member.name;
        const text = `HridyaCare Report\nðŸ‘¤ Patient: ${name}\nâ¤ï¸ BPM: ${currentReportData.selectedReading.bpm}\nGenerated by HridyaCare`;
        
        navigator.clipboard.writeText(text).then(() => showToast("Copied to Clipboard!"));
    }
</script>
{% endblock %}