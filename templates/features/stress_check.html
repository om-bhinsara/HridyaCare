{% extends "layouts/base.html" %}

{% block title %}Stress Level Assessment | CardioSense{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/member-cards.css') }}">
{% endblock %}

{% block content %}
<style>
/* ================= TYPOGRAPHY & GLOBAL ================= */
* {
    font-family: "Outfit", "Segoe UI", system-ui, sans-serif;
    box-sizing: border-box; /* Ensure padding doesn't add width */
}

/* Fix for "Gap on Right Side" */
html, body {
    overflow-x: hidden; /* Hide horizontal scrollbar */
    width: 100%;
    margin: 0;
    padding: 0;
}

nav, .navbar, header, .app-header {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border-bottom: none !important;
    z-index: 10; /* Ensure nav sits on top */
    position: relative;
}

body {
    background-color: #0f172a !important;
    background-image: linear-gradient(180deg, #0f172a 0%, #1e293b 100%) !important;
    background-attachment: fixed;
    font-family: "Outfit", "Segoe UI", system-ui, sans-serif;
    color: #f1f5f9;
}

:root {
    --bg-main: #0f172a;
    --card-bg: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.8));
    --card-border: rgba(255, 255, 255, 0.08);
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    --primary: #ff2d55;
    --primary-hover: #ff4769;
    --primary-glow: rgba(255, 45, 85, 0.5); 
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --outline: rgba(255, 255, 255, 0.2);
    --low: #4ade80;
    --moderate: #fbbf24;
    --high: #f87171;
}

.stress-assessment-wrapper {
    color: var(--text-main);
    line-height: 1.6;
    background: var(--bg-main);
    min-height: 100vh;
    
    /* --- FIXED: FULL WIDTH SPANNING --- */
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw; /* Force viewport width */
    margin-left: calc(50% - 50vw); /* Center and breakout of parent */
    padding-bottom: 50px;
    z-index: 0;
}

.stress-bg-blur {
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    width: 600px;
    height: 400px;
    background: var(--primary);
    opacity: 0.04;
    filter: blur(80px);
    z-index: -1;
    pointer-events: none;
}

.container {
    max-width: 800px;
    margin: auto;
    padding: 100px 20px 100px;
    position: relative;
    z-index: 1;
}

h1 {
    margin: 0 0 8px 0;
    font-size: 28px; 
    text-align: center;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    font-weight: 800;
}

.subtitle {
    color: var(--text-muted);
    margin-bottom: 30px;
    text-align: center;
    font-size: 15px; 
    font-weight: 300;
}

/* ================= STEP CONTAINERS ================= */
.step-container {
    display: none; 
    flex-direction: column;
    width: 100%;
    opacity: 0;
    transition: opacity 0.4s ease-out;
}
.step-container.active { 
    display: flex; 
    opacity: 1;
}

/* ================= UI ELEMENTS ================= */
.progress-text {
    text-align: center;
    color: var(--primary);
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 30px;
    background: rgba(255, 45, 85, 0.1);
    display: inline-block;
    padding: 8px 20px;
    border-radius: 30px;
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    border: 1px solid rgba(255, 45, 85, 0.2);
}

.card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 24px;
    padding: 30px; 
    margin-bottom: 24px;
    box-shadow: var(--card-shadow);
    transition: transform 0.3s ease;
}

/* Question Styles */
.question p {
    font-size: 1.15rem; 
    line-height: 1.5;
    font-weight: 700;
    margin-top: 0;
    margin-bottom: 24px;
    color: #fff;
    letter-spacing: -0.01em;
}

/* Options Styles */
.option {
    display: flex; align-items: center; gap: 16px;
    padding: 16px 20px; border-radius: 16px;
    background: rgba(15, 23, 42, 0.6); 
    border: 1px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 12px; cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
}
.option:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}
.option:has(input:checked) {
    background: linear-gradient(135deg, rgba(255, 45, 85, 0.15) 0%, rgba(255, 45, 85, 0.05) 100%);
    border-color: var(--primary);
    box-shadow: 0 0 25px rgba(255, 45, 85, 0.2);
    transform: scale(1.01); z-index: 1;
}
.option input {
    appearance: none; width: 20px; height: 20px;
    border-radius: 50%; border: 2px solid var(--outline);
    position: relative; background: transparent;
    transition: all 0.2s ease; flex-shrink: 0;
}
.option input:checked {
    border-color: var(--primary); background: var(--primary); box-shadow: 0 0 10px var(--primary-glow);
}
.option input:checked::after {
    content: ""; width: 8px; height: 8px; background: white;
    border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
}
.option span { font-size: 1rem; color: var(--text-muted); font-weight: 500; transition: color 0.2s; }
.option:has(input:checked) span { color: #fff; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

/* Buttons */
.btn-primary {
    background: linear-gradient(135deg, var(--primary), #d91b42);
    color: white; padding: 16px; border-radius: 16px;
    font-size: 15px; font-weight: 700; border: none;
    width: 100%; cursor: pointer; margin-top: 24px;
    box-shadow: 0 4px 20px rgba(255, 45, 85, 0.3);
    transition: all 0.3s ease; letter-spacing: 0.5px;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 45, 85, 0.5); }
.btn-primary:active { transform: translateY(1px); }

.btn-outline {
    background: transparent; color: var(--text-muted);
    padding: 16px; border-radius: 16px; border: 1px solid var(--outline);
    font-size: 15px; width: 100%; margin-top: 16px;
    cursor: pointer; transition: all 0.3s ease; font-weight: 600;
}
.btn-outline:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); }
/* --- MEMBER CARDS --- */

.member-info { flex: 1; display: flex; flex-direction: column; }
.member-name { font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 2px; }
.member-relation { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }


.btn-add-new { width: 100%; padding: 18px; margin-top: 20px; border: 1px dashed rgba(255, 255, 255, 0.15); border-radius: 20px; background: rgba(255, 255, 255, 0.02); color: #94a3b8; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 15px; }
.btn-add-new:hover { background: rgba(255, 255, 255, 0.05); border-color: var(--primary); color: #f8fafc; }
#add-member-form input, #add-member-form select { width: 100%; padding: 16px 20px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; outline: none; margin-top: 15px; text-align: left; appearance: none; transition: border-color 0.2s; }
#add-member-form input:focus, #add-member-form select:focus { border-color: var(--primary); background: #162032; }
.back-btn { background: none; border: none; color: #64748b; font-size: 0.9rem; cursor: pointer; margin: 30px auto 0 auto; padding: 10px; display: block; font-weight: 500; text-align: center; transition: color 0.2s; }
.back-btn:hover { color: #f8fafc; text-decoration: none; }

/* Result Specifics */
.result { display: none; margin-top: 50px; text-align: center; animation: slideUp 0.6s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
.score { font-size: 64px; font-weight: 800; line-height: 1; margin: 10px 0; text-shadow: 0 0 30px rgba(0,0,0,0.5); color: white; }
.low { color: var(--low); text-shadow: 0 0 20px rgba(74, 222, 128, 0.3); }
.moderate { color: var(--moderate); text-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
.high { color: var(--high); text-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
.highlight { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-top: 24px; }
#stressRadar { width: 100% !important; height: 320px !important; max-width: 100%; margin: 20px auto; display: block; filter: drop-shadow(0 0 10px rgba(255, 45, 85, 0.2)); }
.footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); color: var(--text-muted); font-size: 12px; text-align: center; letter-spacing: 1px; opacity: 0.6; }
.breakdown-card { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-radius: 20px; padding: 24px; margin-top: 30px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
.breakdown-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 12px; }
.metric { margin-bottom: 18px; }
.metric-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 8px; color: #cbd5e1; font-weight: 500; }
.metric-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; position: relative; }
.metric-fill { height: 100%; border-radius: 999px; width: 0%; transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px currentColor; position: relative; }
.metric-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: translateX(-100%); animation: shimmer 2s infinite; }
@keyframes shimmer { 100% { transform: translateX(100%); } }
#reductionInfo { background: rgba(15, 23, 42, 0.6); font-size: 15px; line-height: 1.6; color: #e2e8f0; border-left: 4px solid var(--primary); font-weight: 500; }
.info-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; font-size: 11px; font-weight: 800; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; cursor: help; margin-left: 8px; position: relative; border: 1px solid rgba(255,255,255,0.2); transition: background 0.2s; }
.info-icon:hover { background: var(--primary); border-color: var(--primary); }
.tooltip { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%) scale(0.9); background: #1e293b; color: #f1f5f9; padding: 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; width: 260px; opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); z-index: 100; text-align: left; font-weight: 400; }
.tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
.info-icon:hover .tooltip, .info-icon:active .tooltip { opacity: 1; pointer-events: auto; transform: translateX(-50%) scale(1); }
h2 { font-weight: 800; display: flex; justify-content: center; align-items: center; }




</style>

<div class="stress-assessment-wrapper">
    <div class="stress-bg-blur"></div>

    <div class="container">

        <input type="hidden" id="selected-member-id" value="">

        <div id="step-family" class="step-container active">
            <h1 style="margin-bottom: 10px;">Who is taking the test?</h1>
            <p class="subtitle">Select the profile for this stress assessment.</p>

<div id="family-list">
    <div style="text-align:center; padding:40px 0;">
        <div class="spinner"></div>
        <p style="color:#64748b; margin:0;">Loading profiles...</p>
    </div>
</div>



            <button id="btn-show-add-member" class="btn-add-new" onclick="showAddMemberForm()">
                <span style="font-size:18px;">+</span> Add New Member
            </button>

            <div id="add-member-form" style="display:none; margin-top: 10px; background:rgba(30, 41, 59, 0.5); padding:20px; border-radius:20px; border:1px solid rgba(255,255,255,0.05);">
                <h3 style="color:white; font-size:1.1rem; margin-bottom:5px; font-weight:700; text-align:center;">New Profile Details</h3>
                
                <input type="text" id="new-member-name" placeholder="Enter Name (e.g. Rajesh)" autocomplete="off">
                
                <select id="new-member-relation">
                    <option value="" disabled selected>Select Relationship</option>
                    <option value="Father">Father</option>
                    <option value="Mother">Mother</option>
                    <option value="Wife">Wife</option>
                    <option value="Husband">Husband</option>
                    <option value="Elder Brother">Elder Brother</option>
                    <option value="Younger Brother">Younger Brother</option>
                    <option value="Child">Child</option>
                    <option value="Grandfather">Grandfather</option>
                    <option value="Grandmother">Grandmother</option>
                    <option value="Sibling">Sibling</option>
                    <option value="Other">Other</option>
                </select>

                <button id="btn-save-member" class="btn-primary" style="margin-top:15px;" onclick="saveNewMember()">Save Profile</button>
                <button onclick="hideAddMemberForm()" class="back-btn" style="margin-top:10px;">Cancel</button>
            </div>

            <button type="button" class="back-btn" id="back-to-dash-btn" onclick="window.location.href='{{ url_for('index') }}'">‚Üê Back to Dashboard</button>
        </div>

        <div id="step-assessment" class="step-container">
            <h1>Stress Level Assessment</h1>
            <p class="subtitle">Answer based on how you felt during the <b>last month</b></p>
            <div class="progress-text" id="progressText">Question 1 of 10</div>

            <form id="stressForm">
                <script>
                const questions = [
                    "been upset because of something that happened unexpectedly?",
                    "felt that you were unable to control important things in your life?",
                    "felt nervous and stressed?",
                    "felt confident about your ability to handle your personal problems?",
                    "felt that things were going your way?",
                    "found that you could NOT cope with all the things you had to do?",
                    "been able to control irritations in your life?",
                    "felt that you were on top of things?",
                    "been angered because of things outside your control?",
                    "felt difficulties piling up so high that you could not overcome them?"
                ];

                questions.forEach((q, i) => {
                    document.write(`
                    <div class="card question">
                        <p>${i + 1}. In the last month, how often have you ${q}</p>
                        ${["Never","Almost Never","Sometimes","Fairly Often","Very Often"]
                        .map((o,v)=>`
                        <label class="option">
                            <input type="radio" name="q${i}" value="${v}" required>
                            <span>${o}</span>
                        </label>`).join("")}
                    </div>
                    `);
                });
                </script>

                <button class="btn-primary" type="submit">
                    Calculate Stress Score
                </button>
                
                <button type="button" class="back-btn" onclick="goToStep('step-family')">‚Üê Change Profile</button>
            </form>

            <div class="card result" id="resultBox">
                <p id="stressLevel" style="font-weight:700; font-size:18px; margin-bottom:10px; text-align:center; color:white;"></p>
                
                <div style="width:100%; min-height:320px; position:relative;">
                    <canvas id="stressRadar"></canvas>
                </div>
                
                <h2>
                    Your Stress Score
                    <span class="info-icon">‚ìò
                    <span class="tooltip">
                        <b style="color:var(--primary)">What this score means</b><br>
                        This score reflects your overall perceived stress during the last month (PSS-10 scale).<br><br>

                        <b style="color:var(--primary)">Score ranges</b><br>
                        <span style="color:var(--low)">‚óè</span> 0‚Äì13: Low stress<br>
                        <span style="color:var(--moderate)">‚óè</span> 14‚Äì26: Moderate stress<br>
                        <span style="color:var(--high)">‚óè</span> 27‚Äì40: High stress<br><br>

                        <b style="color:var(--primary)">What you can do</b><br>
                        Monitor trends, manage daily stressors, and seek support if high stress persists.
                    </span>
                    
                    </span>
                </h2>
                <div class="score" id="scoreValue" style="text-align:center;"></div>
                <p id="stressLevelText" style="font-size:18px; margin-top:0px; font-weight:600; text-align:center;"></p>
                <p style="font-size:14px;color:var(--text-muted); margin-top:-5px; text-align:center;">out of 40</p>

                <div class="highlight" id="subScoresBox" style="text-align:left; border:none; padding:0;"></div>

                <div class="highlight" id="reductionInfo"></div>
                <button class="btn-outline" onclick="startNewAssessment()">
                    Start New Assessment
                </button>
                <button class="btn-primary" onclick="viewMentalHealthReport()">
                    Back to Dashboard
                </button>
            </div>

        </div> <div class="footer">
            PSS-10 | HridyaCare
        </div>

    </div>
</div>

<script>
    let selectedMemberId = null;

fetch("/api/get-selected-member")
  .then(r => r.json())
  .then(d => selectedMemberId = d.member_id);

/* ================= PAGE NAVIGATION & MEMBER LOGIC ================= */
// Handle step navigation with browser history
function goToStep(stepId, pushHistory = true) {
    document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
    const target = document.getElementById(stepId);
    if (target) target.classList.add('active');

    window.scrollTo(0, 0);

    if (pushHistory) {
        history.pushState({ step: stepId }, "", "#" + stepId);
    }
}
window.onpopstate = function (event) {
    if (!event.state) {
        // Default ‚Üí go to member selection
        goToStep("step-family", false);
        return;
    }

    if (event.state.step === "step-assessment") {
        // Going back from result ‚Üí questions
        document.getElementById("stressForm").style.display = "block";
        document.getElementById("resultBox").style.display = "none";
        goToStep("step-assessment", false);
    }

    if (event.state.step === "step-family") {
        // Going back from questions ‚Üí member selection
        goToStep("step-family", false);
    }

    if (event.state.step === "result") {
        document.getElementById("stressForm").style.display = "none";
        document.getElementById("resultBox").style.display = "block";
    }
};

// Load members on page load
document.addEventListener("DOMContentLoaded", loadMembers);
async function loadMembers() {
    const list = document.getElementById("family-list");

    // Show spinner
    list.innerHTML = `
        <div style="text-align:center; padding:40px 0;">
            <div class="spinner"></div>
            <p style="color:#64748b; margin:0;">Loading profiles...</p>
        </div>`;

    try {
        const res = await fetch('/api/family-members');
        let members = await res.json();
        list.innerHTML = "";

        if (!members || members.length === 0) {
            list.innerHTML = `<p style="color:#ef4444;">No profiles found.</p>`;
            return;
        }

        // Self first
        members.sort((a, b) => {
            const relA = a.relationship.toLowerCase();
            const relB = b.relationship.toLowerCase();
            if (relA === 'self') return -1;
            if (relB === 'self') return 1;
            return 0;
        });

        members.forEach((m, index) => {
            const isSelf = m.relationship.toLowerCase() === 'self';
            const displayName = isSelf ? "You (Self)" : m.name;
            const displayRelation = isSelf ? m.name : m.relationship;

            const card = document.createElement("div");
            card.className = `member-card animate-card ${isSelf ? 'is-self' : ''}`;
            card.style.animationDelay = `${index * 0.1}s`;

            card.onclick = (e) => {
                if (e.target.closest('.delete-btn')) return;
                selectMember(m.id, displayName);
            };

const avatar = `<div class="member-avatar"><span>${isSelf ? '‚ù§Ô∏è' : m.name.charAt(0).toUpperCase()}</span></div>`;

            const deleteBtn = isSelf ? '' : `
                <div class="delete-btn" onclick="deleteMember(${m.id}, '${m.name}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </div>`;

            card.innerHTML = `
                ${avatar}
                <div class="member-info">
                    <div class="member-name">${displayName}</div>
                    <div class="member-relation">${displayRelation}</div>
                </div>
                ${deleteBtn}
            `;

            list.appendChild(card);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = `<p style="color:red;">Failed to load members.</p>`;
    }
}


function selectMember(id, name) {
    document.getElementById("selected-member-id").value = id;
    localStorage.setItem("HCARE_MEMBER_ID", id);

    goToStep('step-assessment');

    // Push questions page into history
    history.pushState({ step: "step-assessment" }, "", "#questions");
}


function showAddMemberForm() { 
    document.getElementById("family-list").style.display = "none"; 
    document.getElementById("btn-show-add-member").style.display = "none"; 
    document.getElementById("add-member-form").style.display = "block"; 
}

function hideAddMemberForm() { 
    document.getElementById("add-member-form").style.display = "none"; 
    document.getElementById("family-list").style.display = "flex"; 
    document.getElementById("btn-show-add-member").style.display = "flex"; 
}

async function saveNewMember() {
    const name = document.getElementById("new-member-name").value;
    const relation = document.getElementById("new-member-relation").value;
    if (!name || !relation) return alert("Fill all fields");
    await fetch('/api/family-members/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, relationship: relation }) });
    hideAddMemberForm(); 
    loadMembers();
}

async function deleteMember(id, name) {
    if(confirm("Remove " + name + "?")) {
        await fetch(`/api/family-members/delete/${id}`, { method: 'DELETE' });
        loadMembers();
    }
}

/* ================= ASSESSMENT LOGIC ================= */

function calculateSubScores() {
    let scores = [];
    for (let i = 0; i < 10; i++) {
        const v = +document.querySelector(`input[name="q${i}"]:checked`).value;
        scores[i] = [3,4,6,7].includes(i) ? (4 - v) : v;
    }
    return {
        emotional: scores[0] + scores[2] + scores[8],     
        control: scores[1] + scores[5] + scores[9],       
        resilience: scores[3] + scores[4] + scores[6] + scores[7],
        cognitive: scores[5] + scores[9],
        anger: scores[0] + scores[8]
    };
}

const METRIC_INFO = {
    "Emotional Stress": { meaning: "Reflects emotional reactions such as anxiety.", improve: "Practice mindfulness & journaling." },
    "Loss of Control": { meaning: "Indicates how much control you feel.", improve: "Prioritize daily goals." },
    "Resilience Level": { meaning: "Measures coping ability.", improve: "Maintain social connections & sleep." },
    "Cognitive Load": { meaning: "Represents mental overload.", improve: "Reduce multitasking." },
    "Anger Reactivity": { meaning: "Shows frustration triggers.", improve: "Pause before reacting." }
};

function renderMetric(label, value, max) {
    const pct = value / max;
    let color, severity;
    if (pct > 0.7) { color = "#f87171"; severity = "High"; } 
    else if (pct > 0.4) { color = "#fbbf24"; severity = "Moderate"; } 
    else { color = "#4ade80"; severity = "Low"; }

    return `
    <div class="metric">
        <div class="metric-header">
           <span style="display:flex; align-items:center;">
              ${label}
              <span class="info-icon">‚ìò<span class="tooltip"><b style="color:var(--primary)">Meaning</b><br>${METRIC_INFO[label].meaning}<br><br><b style="color:var(--primary)">Improve</b><br>${METRIC_INFO[label].improve}</span></span>
            </span>
            <span style="display:flex;gap:10px;align-items:center;">
                <span style="color:${color}; font-weight:700;">${value}/${max}</span>
                <span style="font-size:11px; padding:2px 8px; border-radius:999px; background:${color}15; border: 1px solid ${color}40; color:${color}; font-weight:600; text-transform:uppercase;">${severity}</span>
            </span>
        </div>
        <div class="metric-bar">
            <div class="metric-fill" data-width="${pct * 100}" style="background:${color}; box-shadow: 0 0 12px ${color};"></div>
        </div>
    </div>`;
}

function animateBars() {
    requestAnimationFrame(() => {
        document.querySelectorAll(".metric-fill").forEach(bar => {
            bar.style.width = bar.dataset.width + "%";
        });
    });
}

document.addEventListener("change", () => {
    const answered = new Set([...document.querySelectorAll("input[type=radio]:checked")].map(i => i.name)).size;
    document.getElementById("progressText").innerText = `Question ${Math.min(answered + 1, 10)} / 10`;
});

document.getElementById("stressForm").addEventListener("submit", e => {
    e.preventDefault();

    let total = 0;
    for (let i = 0; i < 10; i++) {
        const v = +document.querySelector(`input[name="q${i}"]:checked`).value;
        total += [3,4,6,7].includes(i) ? (4 - v) : v;
    }

    const subs = calculateSubScores();
    const memberId = document.getElementById("selected-member-id").value;

    let levelText, levelClass;
    if (total <= 13) { levelText = "Low Stress"; levelClass = "low"; }
    else if (total <= 26) { levelText = "Moderate Stress"; levelClass = "moderate"; }
    else { levelText = "High Stress"; levelClass = "high"; }

    document.getElementById("scoreValue").innerText = `${total}`;
    document.getElementById("stressLevelText").innerText = levelText;
    document.getElementById("stressLevelText").className = levelClass;
    document.getElementById("scoreValue").className = "score " + levelClass;
    document.getElementById("stressLevel").innerText = levelText.toUpperCase();
    document.getElementById("stressLevel").className = levelClass;

    let insight_present = total <= 13 ? "Stress levels appear well managed." : "Elevated stress detected.";
    let insight_past = total <= 13 ? "Stress levels appeared well managed." : "Elevated stress was detected.";

    document.getElementById("subScoresBox").innerHTML = `
    <div class="breakdown-card">
      <div class="breakdown-title"><span>üìä Stress Breakdown</span></div>
      ${renderMetric("Emotional Stress", subs.emotional, 12)}
      ${renderMetric("Loss of Control", subs.control, 12)}
      ${renderMetric("Resilience Level", subs.resilience, 16)}
      ${renderMetric("Cognitive Load", subs.cognitive, 8)}
      ${renderMetric("Anger Reactivity", subs.anger, 8)}
    </div>`;
    
    document.getElementById("reductionInfo").innerText = insight_present;

    // HIDE FORM, SHOW RESULT ON SAME PAGE
    document.getElementById("stressForm").style.display = "none";
    
    document.getElementById("resultBox").style.display = "block";

    history.pushState({ step: "result" }, "", "#result");

    setTimeout(() => {
    window.scrollTo(0, 0);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}, 50);
    // Draw chart
    setTimeout(() => {
        drawRadarChart(subs);
        animateBars();
    }, 100);

    // --- FIX: SCROLL TO TOP ---
    window.scrollTo({ top: 0, behavior: "smooth" });

    fetch("/api/stress/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            total: total,
            level: levelText,
            emotional: subs.emotional,
            control: subs.control,
            resilience: subs.resilience,
            cognitive: subs.cognitive,
            anger: subs.anger,
            insight_present: insight_present,
            insight_past: insight_past,
            member_id: memberId
        })
    }).catch(err => console.error("‚ùå Save failed", err));
});

function viewMentalHealthReport() { window.location.href = "/"; }

function startNewAssessment() {
    document.getElementById("stressForm").reset();
    document.getElementById("stressForm").style.display = "block";
    document.getElementById("resultBox").style.display = "none";
    document.getElementById("progressText").innerText = "Question 1 of 10";
    goToStep('step-family'); 
}

/* ===== Radar Chart Drawing ===== */
function drawRadarChart(data) {
    const canvas = document.getElementById("stressRadar");
    const ctx = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    let rect = canvas.getBoundingClientRect();
    if(rect.width === 0) rect = { width: 320, height: 320 }; 

    canvas.width = rect.width * dpr;
    canvas.height = 320 * dpr; 
    ctx.scale(dpr, dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = '320px';

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const cx = rect.width / 2;
    const cy = 160; 
    const radius = 100; 
    const labels = ["Emotional", "Control", "Resilience", "Cognitive", "Anger"];
    const values = [data.emotional, data.control, data.resilience, data.cognitive, data.anger];
    const angleStep = (2 * Math.PI) / labels.length;

    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.lineWidth = 1;
    for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        for (let j = 0; j < labels.length; j++) {
            const angle = j * angleStep - Math.PI / 2;
            const r = (radius / 5) * i;
            const x = cx + r * Math.cos(angle);
            const y = cy + r * Math.sin(angle);
            j === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();
    }

    ctx.fillStyle = "#94a3b8";
    ctx.font = "600 11px Outfit";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    labels.forEach((label, i) => {
        const angle = i * angleStep - Math.PI / 2;
        const x = cx + (radius + 25) * Math.cos(angle);
        const y = cy + (radius + 25) * Math.sin(angle);
        ctx.fillText(label, x, y);
    });

    ctx.beginPath();
    values.forEach((val, i) => {
        const angle = i * angleStep - Math.PI / 2;
        const maxValues = [12, 12, 16, 8, 8];
        const r = (val / maxValues[i]) * radius;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.fillStyle = "rgba(255, 45, 85, 0.25)";
    ctx.strokeStyle = "#ff2d55";
    ctx.lineWidth = 3;
    ctx.lineJoin = "round";
    ctx.fill();
    ctx.stroke();
    
    values.forEach((val, i) => {
        const angle = i * angleStep - Math.PI / 2;
        const maxValues = [12, 12, 16, 8, 8];
        const r = (val / maxValues[i]) * radius;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fillStyle = "#fff";
        ctx.fill();
    });
}
const selectedMember = sessionStorage.getItem("selected_member_id") || null;
history.replaceState({ step: "step-family" }, "", "#members");

</script>

{% endblock %}